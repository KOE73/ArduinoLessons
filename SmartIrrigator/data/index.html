<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>Irrigation Control</title>
    <!-- Bootstrap 5 CDN (minified) -->
    <!--<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">-->
    <link href="bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 50px;
        }

        .status span {
            font-weight: bold;
        }
    </style>
</head>

<body class="bg-light">

    <div class="container text-center">
        <h1 class="mb-4">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–∏–≤–æ–º</h1>

        <div class="row justify-content-center status mb-4">
            <div class="col-md-4">
                <p>–ù–∞—Å–æ—Å –ø–æ–ª–∏–≤–∞: <span id="irrigationStatus" class="text-primary">?</span></p>
                <p>–ù–∞—Å–æ—Å –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏—è: <span id="fillStatus" class="text-primary">?</span></p>
                <p>–ë–æ—á–∫–∞ –ø–æ–ª–Ω–∞—è: <span id="isFull" class="text-primary">?</span></p>
                <p>–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è: <span id="currentTime" class="text-primary">?</span></p>
            </div>
        </div>

        <div class="row justify-content-center mb-3">
            <div class="col-auto">
                <button class="btn btn-success me-2" onclick="sendControl('irrigation', 1)">–í–∫–ª—é—á–∏—Ç—å –ø–æ–ª–∏–≤</button>
                <button class="btn btn-danger" onclick="sendControl('irrigation', 0)">–í—ã–∫–ª—é—á–∏—Ç—å –ø–æ–ª–∏–≤</button>
            </div>
        </div>

        <div class="row justify-content-center">
            <div class="col-auto">
                <button class="btn btn-success me-2" onclick="sendControl('fill', 1)">–í–∫–ª—é—á–∏—Ç—å –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏–µ</button>
                <button class="btn btn-danger" onclick="sendControl('fill', 0)">–í—ã–∫–ª—é—á–∏—Ç—å –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏–µ</button>
            </div>
        </div>

        <div class="container mt-5">
            <h2>–†–∞—Å–ø–∏—Å–∞–Ω–∏—è</h2>
            <form id="scheduleForm">
                <table class="table table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>–í–∫–ª</th>
                            <th>–°—Ç–∞—Ä—Ç</th>
                            <th>–°—Ç–æ–ø</th>
                            <th>–ö–ª–∞–ø–∞–Ω—ã</th>
                            <th>–ü–æ–ª–∏–≤</th>
                            <th>–ù–∞–ø–æ–ª–Ω–µ–Ω–∏–µ</th>
                            <th>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</th>
                        </tr>
                    </thead>
                    <tbody id="scheduleBody"></tbody>
                </table>
            </form>
        </div>

    </div>



    <!-- Bootstrap JS (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è —ç—Ç–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞, –Ω–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏) -->
    <script>
        function sendControl(target, value) {
            fetch(`/control?target=${target}&value=${value}`)
                .then(res => res.ok ? updateState() : alert("–û—à–∏–±–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è"))
                .catch(err => alert("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è"));
        }

        function updateState() {
            fetch('/state')
                .then(res => res.json())
                .then(data => {
                    document.getElementById('irrigationStatus').textContent = data.out_IrrigationPumpOn ? '–í–ö–õ' : '–í–´–ö–õ';
                    document.getElementById('fillStatus').textContent = data.out_FillPumpOn ? '–í–ö–õ' : '–í–´–ö–õ';
                    document.getElementById('isFull').textContent = data.in_IsFull ? '–î–∞' : '–ù–µ—Ç';
                    document.getElementById('currentTime').textContent = data.hasTime ?
                        new Date(data.timeInfo.year + 1900, data.timeInfo.month, data.timeInfo.day,
                            data.timeInfo.hour, data.timeInfo.min, data.timeInfo.sec).toLocaleTimeString('ru-RU') :
                        '–ù–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ';

                    // –¶–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è
                    updateColor('irrigationStatus', data.out_IrrigationPumpOn);
                    updateColor('fillStatus', data.out_FillPumpOn);
                    updateColor('isFull', data.in_IsFull);
                });
        }

        function updateColor(id, state) {
            const el = document.getElementById(id);
            el.classList.remove('text-success', 'text-danger');
            el.classList.add(state ? 'text-success' : 'text-danger');
        }

        setInterval(updateState, 5000);
        updateState();



        function loadSchedules() {
            fetch('/schedules')
                .then(res => res.json())
                .then(data => {
                    const tbody = document.getElementById("scheduleBody");
                    tbody.innerHTML = "";

                    data.forEach((s, i) => {
                        const row = document.createElement("tr");

                        const valveCheckboxes = s.valves.map((v, idx) =>
                            `<label class='form-check form-check-inline'>
                        <input type="checkbox" class="form-check-input" name="v${i}_${idx}" ${v ? "checked" : ""}>
                        V${idx + 1}
                    </label>`
                        ).join(" ");

                        row.innerHTML = `
                    <td>${i + 1}</td>
                    <td><input type="checkbox" name="enabled${i}" ${s.enabled ? "checked" : ""}></td>
                    <td><input type="time" name="start${i}" value="${toTimeStr(s.startTime)}"></td>
                    <td><input type="time" name="end${i}" value="${toTimeStr(s.endTime)}"></td>
                    <td>${valveCheckboxes}</td>
                    <td><input type="checkbox" name="irrigation${i}" ${s.irrigationPump ? "checked" : ""}></td>
                    <td><input type="checkbox" name="fill${i}" ${s.fillPump ? "checked" : ""}></td>
                    <td><button type="button" class="btn btn-sm btn-success" onclick="saveSchedule(${i})">üíæ</button></td>
                `;
                        tbody.appendChild(row);
                    });
                });
        }

        function toTimeStr(mins) {
            const h = String(Math.floor(mins / 60)).padStart(2, "0");
            const m = String(mins % 60).padStart(2, "0");
            return `${h}:${m}`;
        }

        function timeToMinutes(tstr) {
            const [h, m] = tstr.split(":").map(Number);
            return h * 60 + m;
        }

        function saveSchedule(index) {
            const form = document.forms["scheduleForm"];
            const entry = {
                index: index,
                enabled: form[`enabled${index}`].checked,
                startTime: timeToMinutes(form[`start${index}`].value),
                endTime: timeToMinutes(form[`end${index}`].value),
                irrigationPump: form[`irrigation${index}`].checked,
                fillPump: form[`fill${index}`].checked,
                valves: []
            };
            for (let i = 0; i < 8; i++) {
                const input = form[`v${index}_${i}`];
                if (!input) break;
                entry.valves.push(input.checked);
            }

            fetch('/schedules', {
                method: 'POST',
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(entry)
            })
                .then(() => loadSchedules());
        }
    </script>
</body>

</html>