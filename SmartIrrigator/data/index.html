<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Irrigation Control</title>
    <!-- Bootstrap 5 CDN (minified) -->
    <!--<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">-->
    <link href="bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 10px;
            font-size: 1rem;
        }

        .status span {
            font-weight: bold;
        }



        @media (max-width: 576px) {
            h1 {
                font-size: 1.5rem;
            }

            .btn {
                width: 100%;
                margin-bottom: 10px;
            }

            .form-check {
                display: block;
            }
        }
    </style>
</head>

<body class="bg-light">

    <div class="container text-center">
        <h1 class="mb-1">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–∏–≤–æ–º</h1>

        <div class="container text-center">

            <!-- –í—Ä–µ–º—è -->
            <div class="row justify-content-center">
                <div class="col-12 col-md-4 mb-2 mb-md-0">
                    <div class="card shadow-sm">
                        <div class="card-header bg-info text-white p-0">
                            –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
                        </div>
                        <div class="card-body p-2">
                            <strong><span id="currentTime">?</span></strong>
                            [<strong><span id="minutesSinceMidnight">?</span></strong>]
                        </div>
                    </div>
                </div>

                <!-- –ù–∞—Å–æ—Å –ø–æ–ª–∏–≤–∞ -->
                <div class="col-12 col-md-4 mb-2 mb-md-0">
                    <div class="card shadow-sm">
                        <div class="card-header bg-primary text-white p-0">
                            –ü–æ–ª–∏–≤
                        </div>
                        <div class="card-body d-flex align-items-center justify-content-between flex-wrap gap-2 p-1">

                            <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å: —Å—Ç–∞—Ç—É—Å -->
                            <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center gap-2">
                                <span id="irrigationStatus" class="badge rounded-pill bg-light text-dark">–ù–∞—Å–æ—Å</span>

                                <!-- –ó–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è badges –ø–æ –∫–ª–∞–ø–∞–Ω–∞–º -->
                                <span id="valveStatus" class="d-flex gap-1 flex-wrap"></span>
                            </div>


                            <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å: –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å -->
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="irrigationSwitch"
                                    onchange="sendControl('irrigation', this.checked ? 1 : 0)">
                            </div>

                        </div>
                    </div>
                </div>

                <!-- –ù–∞—Å–æ—Å –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏—è -->
                <div class="col-12 col-md-4 mb-2 mb-md-0">
                    <div class="card shadow-sm">
                        <div class="card-header bg-success text-white p-0">
                            –ë–æ—á–∫–∞
                        </div>
                        <div class="card-body d-flex align-items-center justify-content-between flex-wrap gap-2 p-1">

                            <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å: —Å—Ç–∞—Ç—É—Å—ã -->
                            <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center gap-2">
                                <span id="fillStatus" class="badge rounded-pill bg-light text-dark">–ù–∞—Å–æ—Å</span>
                                <span id="isFull" class="badge rounded-pill bg-light text-dark">–£—Ä–æ–≤–µ–Ω—å</span>
                            </div>

                            <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å: –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å -->
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="fillPumpSwitch"
                                    onchange="sendControl('fill', this.checked ? 1 : 0)">
                            </div>

                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div class="container mt-1">
            <h2>–†–∞—Å–ø–∏—Å–∞–Ω–∏—è</h2>
            <form id="scheduleForm">
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>–í–∫–ª</th>
                                <th>–°—Ç–∞—Ä—Ç</th>
                                <th>–°—Ç–æ–ø</th>
                                <th>–ö–ª–∞–ø–∞–Ω—ã</th>
                                <th>–ü–æ–ª–∏–≤</th>
                                <th>–ù–∞–ø–æ–ª–Ω–µ–Ω–∏–µ</th>
                                <th>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</th>
                            </tr>
                        </thead>
                        <tbody id="scheduleBody"></tbody>
                    </table>
                </div>
            </form>
        </div>

    </div>



    <!-- Bootstrap JS (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è —ç—Ç–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞, –Ω–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏) -->
    <script>
        function sendControl(target, value) {
            fetch(`/control?target=${target}&value=${value}`)
                .then(res => res.ok ? updateState() : alert("–û—à–∏–±–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è"))
                .catch(err => alert("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è"));
        }


        function updateState() {
            fetch('/state')
                .then(res => res.json())
                .then(data => {

                    //document.getElementById('irrigationStatus').textContent = data.out_IrrigationPumpOn ? '–í–ö–õ' : '–í–´–ö–õ';
                    const irrigationEl = document.getElementById('irrigationStatus');
                    irrigationEl.className = 'badge rounded-pill ' + (data.out_IrrigationPumpOn ? 'bg-success' : 'bg-secondary');

                    const valveStatus = document.getElementById('valveStatus');
                    valveStatus.innerHTML = ''; // –æ—á–∏—Å—Ç–∏–º –ø–µ—Ä–µ–¥ –≤—Å—Ç–∞–≤–∫–æ–π

                    if (Array.isArray(data.valves)) {
                        data.valves.forEach((isOpen, i) => {
                            const badge = document.createElement('span');
                            badge.className = 'badge rounded-pill ' + (isOpen ? 'bg-primary text-white' : 'bg-light text-dark');
                            badge.textContent = `V${i + 1}`;
                            valveStatus.appendChild(badge);
                        });
                    }

                    //document.getElementById('fillStatus').textContent = data.out_FillPumpOn ? '–í–ö–õ' : '–í–´–ö–õ';
                    //document.getElementById('isFull').textContent = data.in_IsFull ? '–î–∞' : '–ù–µ—Ç';
                    // fillStatus
                    const fillStatusEl = document.getElementById('fillStatus');
                    //fillStatusEl.textContent = data.out_FillPumpOn ? '–ù–∞—Å–æ—Å' : '–í–´–ö–õ';
                    fillStatusEl.className = 'badge rounded-pill ' + (data.out_FillPumpOn ? 'bg-success' : 'bg-secondary');

                    // isFull
                    const isFullEl = document.getElementById('isFull');
                    //isFullEl.textContent = data.in_IsFull ? '–ü–æ–ª–Ω–∞—è' : '–ù–µ –ø–æ–ª–Ω–∞—è';
                    isFullEl.className = 'badge rounded-pill ' + (data.in_IsFull ? 'bg-primary' : 'bg-warning');



                    //document.getElementById('currentTime').textContent = data.hasTime ?
                    //    new Date(data.timeInfo.year + 1900, data.timeInfo.month, data.timeInfo.mday,
                    //        data.timeInfo.hour, data.timeInfo.min, data.timeInfo.sec).toLocaleTimeString('ru-RU') :
                    //    '–ù–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ';

                    const t = data.timeInfo;
                    if (data.hasTime && t) {
                        const timeStr = `${pad(t.hour)}:${pad(t.min)}:${pad(t.sec)}`;
                        document.getElementById('currentTime').textContent = timeStr;
                    } else {
                        document.getElementById('currentTime').textContent = "–ù–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ";
                    }
                    document.getElementById('minutesSinceMidnight').textContent = toTimeStr(data.minutesSinceMidnight);

                    // –¶–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è
                    //updateColor('irrigationStatus', data.out_IrrigationPumpOn);
                    //updateColor('fillStatus', data.out_FillPumpOn);
                    //updateColor('isFull', data.in_IsFull);

                    // üëá –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è
                    document.getElementById('fillPumpSwitch').checked = data.in_IsManualFill;
                    document.getElementById('irrigationSwitch').checked = data.in_IsManualIrrigation;
                });
        }

        function updateColor(id, state) {
            const el = document.getElementById(id);
            el.classList.remove('text-success', 'text-danger');
            el.classList.add(state ? 'text-success' : 'text-danger');
        }

        setInterval(updateState, 250);
        updateState();



        function loadSchedules() {
            fetch('/schedules')
                .then(res => res.json())
                .then(data => {
                    const tbody = document.getElementById("scheduleBody");
                    tbody.innerHTML = "";

                    data.forEach((s, i) => {
                        const row = document.createElement("tr");
                        const valveCheckboxes = s.valves.map((v, idx) => {
                            const inputId = `${i}_v${idx}`;  // —É–Ω–∏–∫–∞–ª—å–Ω—ã–π id –Ω–∞ –∫–∞–∂–¥—ã–π —á–µ–∫–±–æ–∫—Å
                            return `
                                <input type="checkbox" class="btn-check" id="${inputId}" name="${inputId}" autocomplete="off" ${v ? "checked" : ""}>
                                <label class="btn btn-outline-primary btn-sm" for="${inputId}">V${idx + 1}</label>
                            `;
                        }).join(" ");

                        row.innerHTML = `
                            <td>${i + 1}</td>
                        <td>
                            <div class="form-check form-switch m-0">
                                <input class="form-check-input" type="checkbox" id="${i}_enabled" name="${i}_enabled" ${s.enabled ? "checked" : ""}>
                              </div>
                            </td>
                            <td><input type="time" class="form-control form-control-sm" id="${i}_start" name="${i}_start" value="${toTimeStr(s.startTime)}"></td>
                            <td><input type="time" class="form-control form-control-sm" id="${i}_end" name="${i}_end" value="${toTimeStr(s.endTime)}"></td>
                            <td>${valveCheckboxes}</td>
                            <td>
                              <div class="form-check form-switch m-0">
                                <input class="form-check-input" type="checkbox" id="${i}_irrigation" name="${i}_irrigation" ${s.irrigationPump ? "checked" : ""}>
                              </div>
                            </td>
                            <td>
                              <div class="form-check form-switch m-0">
                                <input class="form-check-input" type="checkbox" id="${i}_fill" name="${i}_fill" ${s.fillPump ? "checked" : ""}>
                              </div>
                            </td>
                             <td><button type="button" class="btn btn-sm btn-success" onclick="saveSchedule(${i})">üíæ</button></td>
                            `;
                        tbody.appendChild(row);
                    });
                });
        }

        function pad(n) {
            return n.toString().padStart(2, '0');
        }

        function toTimeStr(mins) {
            const h = String(Math.floor(mins / 60)).padStart(2, "0");
            const m = String(mins % 60).padStart(2, "0");
            return `${h}:${m}`;
        }

        function timeToMinutes(tstr) {
            const [h, m] = tstr.split(":").map(Number);
            return h * 60 + m;
        }

        function saveSchedule(index) {
            const form = document.forms["scheduleForm"];
            const get = id => document.getElementById(`${index}_${id}`);

            const entry = {
                index: index,
                enabled: get("enabled").checked,
                startTime: timeToMinutes(get("start").value),
                endTime: timeToMinutes(get("end").value),
                irrigationPump: get("irrigation").checked,
                fillPump: get("fill").checked,
                valves: []
            };

            for (let i = 0; i < 8; i++) {
                const valveInput = document.getElementById(`${index}_v${i}`);
                if (!valveInput) break;
                entry.valves.push(valveInput.checked);
            }

            fetch('/schedules', {
                method: 'POST',
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(entry)
            })
                .then(() => loadSchedules());
        }

        loadSchedules();
    </script>

    <script src="bootstrap.bundle.min.js"></script>

</body>

</html>