<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Irrigation Control</title>
    <!-- Bootstrap 5 CDN (minified) -->
    <!--<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">-->
    <link href="bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 10px;
            font-size: 1rem;
        }

        .status span {
            font-weight: bold;
        }



        @media (max-width: 576px) {
            h1 {
                font-size: 1.5rem;
            }

            .btn {
                width: 100%;
                margin-bottom: 10px;
            }

            .form-check {
                display: block;
            }
        }
    </style>
</head>

<body class="bg-light">

    <div class="container text-center">
        <h1 class="mb-1">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–∏–≤–æ–º</h1>

        <div class="container text-center">

            <!-- –í—Ä–µ–º—è -->
            <div class="row justify-content-center">
                <div class="col-12 col-md-4 mb-2 mb-md-0">
                    <div class="card shadow-sm">
                        <div class="card-header bg-info text-white p-0">
                            –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
                        </div>
                        <div class="card-body p-2">
                            <strong><span id="currentTime">?</span></strong>
                            [<strong><span id="minutesSinceMidnight">?</span></strong>]

                            <!-- –í—Ä–µ–º—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è —Ä—É—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ -->
                            <div id="manualOffTimeContainer" class="mt-1 d-none">
                                <div class="d-flex justify-content-center align-items-baseline flex-wrap gap-2  text-nowrap">
                                    <div>
                                        ‚è± <span class="badge bg-warning text-dark" id="manualOffTimeText">?</span>
                                    </div>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-outline-secondary"
                                            onclick="sendControl('manualOffAdjust', -5)">‚àí5 –º–∏–Ω</button>
                                        <button class="btn btn-outline-secondary"
                                            onclick="sendControl('manualOffAdjust', 5)">+5 –º–∏–Ω</button>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- –ù–∞—Å–æ—Å –ø–æ–ª–∏–≤–∞ -->
                <div class="col-12 col-md-4 mb-2 mb-md-0">
                    <div class="card shadow-sm">
                        <div class="card-header bg-primary text-white p-0">
                            –ü–æ–ª–∏–≤
                        </div>
                        <div class="card-body align-items-center flex-wrap gap-2 p-1">


                            <!-- –ù–∞—Å–æ—Å –ø–æ–ª–∏–≤–∞ -->
                            <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                                <!-- –°–ª–µ–≤–∞ —Å—Ç–∞—Ç—É—Å –Ω–∞—Å–æ—Å–∞ -->
                                <span id="out_IrrigationPumpOn"
                                    class="badge rounded-pill bg-light text-dark">–ù–∞—Å–æ—Å</span>

                                <!-- –°–ø—Ä–∞–≤–∞ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å -->
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="irrigationSwitch"
                                        onchange="sendControl('irrigation', this.checked ? 1 : 0)">
                                </div>
                            </div>

                            <!-- –ö–ª–∞–ø–∞–Ω—ã (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è —Å—é–¥–∞) -->
                            <div id="valveStatus" class="d-flex flex-column gap-2 mt-2">
                                <!-- JS –¥–æ–±–∞–≤–∏—Ç —Å—é–¥–∞ –ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏:
                                    <div class="d-flex align-items-center justify-content-between">
                                        <span class="badge rounded-pill bg-primary">V1</span>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="valveSwitch0"
                                                onchange="sendControl('valve0', this.checked ? 1 : 0)">
                                        </div>
                                    </div>
                                -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –ù–∞—Å–æ—Å –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏—è -->
                <div class="col-12 col-md-4 mb-2 mb-md-0">
                    <div class="card shadow-sm">
                        <div class="card-header bg-success text-white p-0">
                            –ë–æ—á–∫–∞
                        </div>
                        <div class="card-body d-flex align-items-center justify-content-between flex-wrap gap-2 p-1">

                            <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å: —Å—Ç–∞—Ç—É—Å—ã -->
                            <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center gap-2">
                                <span id="out_FillPumpOn" class="badge rounded-pill bg-light text-dark">–ù–∞—Å–æ—Å</span>
                                <span id="in_IsFull" class="badge rounded-pill bg-light text-dark">–£—Ä–æ–≤–µ–Ω—å</span>
                            </div>

                            <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å: –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å -->
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="fillPumpSwitch"
                                    onchange="sendControl('fill', this.checked ? 1 : 0)">
                            </div>

                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div class="container mt-1">
            <h2>–†–∞—Å–ø–∏—Å–∞–Ω–∏—è</h2>
            <form id="scheduleForm">
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>–í–∫–ª</th>
                                <th>–°—Ç–∞—Ä—Ç</th>
                                <th>–°—Ç–æ–ø</th>
                                <th>–ö–ª–∞–ø–∞–Ω—ã</th>
                                <th>–ü–æ–ª–∏–≤</th>
                                <th>–ù–∞–ø–æ–ª–Ω–µ–Ω–∏–µ</th>
                                <th>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</th>
                            </tr>
                        </thead>
                        <tbody id="scheduleBody"></tbody>
                    </table>
                </div>
            </form>
        </div>

    </div>



    <!-- Bootstrap JS (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è —ç—Ç–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞, –Ω–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏) -->
    <script>
        function sendControl(target, value) {
            fetch(`/control?target=${target}&value=${value}`)
                .then(res => res.ok ? updateState() : alert("–û—à–∏–±–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è"))
                .catch(err => alert("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è"));
        }


        function updateState() {
            fetch('/state')
                .then(res => res.json())
                .then(data => {

                    const out_IrrigationPumpOn = document.getElementById('out_IrrigationPumpOn');
                    out_IrrigationPumpOn.classList.remove('bg-success', 'bg-danger', 'bg-secondary', 'bg-warning', 'bg-primary', 'bg-light', 'text-dark');
                    out_IrrigationPumpOn.classList.add(!!data.out_IrrigationPumpOn ? 'bg-success' : 'bg-secondary');

                    updateValves(data.out_ValveOn, data.in_IsManualValveOn);

                    // fillStatus
                    const out_FillPumpOn = document.getElementById('out_FillPumpOn');
                    out_FillPumpOn.classList.remove('bg-success', 'bg-danger', 'bg-secondary', 'bg-warning', 'bg-primary', 'bg-light', 'text-dark');
                    out_FillPumpOn.classList.add(!!data.out_FillPumpOn ? 'bg-success' : 'bg-secondary');

                    // isFull
                    const in_IsFull = document.getElementById('in_IsFull');
                    in_IsFull.classList.remove('bg-success', 'bg-danger', 'bg-secondary', 'bg-warning', 'bg-primary', 'bg-light', 'text-dark');
                    in_IsFull.classList.add(!!data.in_IsFull ? 'bg-primary' : 'bg-warning');



                    //document.getElementById('currentTime').textContent = data.hasTime ?
                    //    new Date(data.timeInfo.year + 1900, data.timeInfo.month, data.timeInfo.mday,
                    //        data.timeInfo.hour, data.timeInfo.min, data.timeInfo.sec).toLocaleTimeString('ru-RU') :
                    //    '–ù–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ';

                    const nowTimeInfo = data.nowTimeInfo;
                    if (data.hasTime && nowTimeInfo) {
                        const timeStr = `üïî ${pad(nowTimeInfo.hour)}:${pad(nowTimeInfo.min)}:${pad(nowTimeInfo.sec)}`;
                        document.getElementById('currentTime').textContent = timeStr;
                    } else {
                        document.getElementById('currentTime').textContent = "üïî üîÑ";
                    }
                    document.getElementById('minutesSinceMidnight').textContent = toTimeStr(data.minutesSinceMidnight);


                    const manualOffTimeContainer = document.getElementById("manualOffTimeContainer");
                    const manualOffText = document.getElementById("manualOffTimeText");

                    if (data.in_TimeInfoManualOff) {
                        const timeManual = data.in_TimeInfoManualOff;
                        const hh = String(timeManual.hour).padStart(2, '0');
                        const mm = String(timeManual.min).padStart(2, '0');
                        const ss = String(timeManual.sec).padStart(2, '0');
                        manualOffText.textContent = `${hh}:${mm}:${ss}`;
                        manualOffTimeContainer.classList.remove("d-none");
                    } else {
                        manualOffTimeContainer.classList.add("d-none");
                    }


                    // –¶–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è
                    //updateColor('irrigationStatus', data.out_IrrigationPumpOn);
                    //updateColor('fillStatus', data.out_FillPumpOn);
                    //updateColor('isFull', data.in_IsFull);

                    // üëá –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è
                    document.getElementById('fillPumpSwitch').checked = data.in_IsManualFill;
                    document.getElementById('irrigationSwitch').checked = data.in_IsManualIrrigation;
                });
        }

        function updateValves(valves, manualStates) {
            const container = document.getElementById('valveStatus');
            container.innerHTML = '';
            const frag = document.createDocumentFragment();

            for (let i = 0; i < valves.length; i++) {
                const wrapper = document.createElement('div');
                wrapper.className = "d-flex align-items-center justify-content-between";

                const badge = document.createElement('span');
                badge.className = "badge rounded-pill " + (valves[i] ? "bg-primary" : "bg-light text-dark");
                badge.textContent = `V${i + 1}`;

                const toggleWrap = document.createElement('div');
                toggleWrap.className = "form-check form-switch";

                const toggle = document.createElement('input');
                toggle.className = "form-check-input";
                toggle.type = "checkbox";
                toggle.id = `valveSwitch${i}`;
                toggle.checked = !!manualStates[i];
                toggle.onchange = () => sendControl(`valve${i}`, toggle.checked ? 1 : 0);

                toggleWrap.appendChild(toggle);
                wrapper.appendChild(badge);
                wrapper.appendChild(toggleWrap);
                frag.appendChild(wrapper);
            }

            container.appendChild(frag);
        }


        function updateColor(id, state) {
            const el = document.getElementById(id);
            el.classList.remove('text-success', 'text-danger');
            el.classList.add(state ? 'text-success' : 'text-danger');
        }

        setInterval(updateState, 250);
        updateState();



        function loadSchedules() {
            fetch('/schedules')
                .then(res => res.json())
                .then(data => {
                    const tbody = document.getElementById("scheduleBody");
                    tbody.innerHTML = "";

                    data.forEach((s, i) => {
                        const row = document.createElement("tr");
                        const valveCheckboxes = s.valves.map((v, idx) => {
                            const inputId = `${i}_v${idx}`;  // —É–Ω–∏–∫–∞–ª—å–Ω—ã–π id –Ω–∞ –∫–∞–∂–¥—ã–π —á–µ–∫–±–æ–∫—Å
                            return `
                                <input type="checkbox" class="btn-check" id="${inputId}" name="${inputId}" autocomplete="off" ${v ? "checked" : ""}>
                                <label class="btn btn-outline-primary btn-sm" for="${inputId}">V${idx + 1}</label>
                            `;
                        }).join(" ");

                        row.innerHTML = `
                            <td>${i + 1}</td>
                        <td>
                            <div class="form-check form-switch m-0">
                                <input class="form-check-input" type="checkbox" id="${i}_enabled" name="${i}_enabled" ${s.enabled ? "checked" : ""}>
                              </div>
                            </td>
                            <td><input type="time" class="form-control form-control-sm" id="${i}_start" name="${i}_start" value="${toTimeStr(s.startTime)}"></td>
                            <td><input type="time" class="form-control form-control-sm" id="${i}_end" name="${i}_end" value="${toTimeStr(s.endTime)}"></td>
                            <td>${valveCheckboxes}</td>
                            <td>
                              <div class="form-check form-switch m-0">
                                <input class="form-check-input" type="checkbox" id="${i}_irrigation" name="${i}_irrigation" ${s.irrigationPump ? "checked" : ""}>
                              </div>
                            </td>
                            <td>
                              <div class="form-check form-switch m-0">
                                <input class="form-check-input" type="checkbox" id="${i}_fill" name="${i}_fill" ${s.fillPump ? "checked" : ""}>
                              </div>
                            </td>
                             <td><button type="button" class="btn btn-sm btn-success" onclick="saveSchedule(${i})">üíæ</button></td>
                            `;
                        tbody.appendChild(row);
                    });
                });
        }

        function pad(n) {
            return n.toString().padStart(2, '0');
        }

        function toTimeStr(mins) {
            const h = String(Math.floor(mins / 60)).padStart(2, "0");
            const m = String(mins % 60).padStart(2, "0");
            return `${h}:${m}`;
        }

        function timeToMinutes(tstr) {
            const [h, m] = tstr.split(":").map(Number);
            return h * 60 + m;
        }

        function saveSchedule(index) {
            const form = document.forms["scheduleForm"];
            const get = id => document.getElementById(`${index}_${id}`);

            const entry = {
                index: index,
                enabled: get("enabled").checked,
                startTime: timeToMinutes(get("start").value),
                endTime: timeToMinutes(get("end").value),
                irrigationPump: get("irrigation").checked,
                fillPump: get("fill").checked,
                valves: []
            };

            for (let i = 0; i < 8; i++) {
                const valveInput = document.getElementById(`${index}_v${i}`);
                if (!valveInput) break;
                entry.valves.push(valveInput.checked);
            }

            fetch('/schedules', {
                method: 'POST',
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(entry)
            })
                .then(() => loadSchedules());
        }

        loadSchedules();
    </script>

    <script src="bootstrap.bundle.min.js"></script>

</body>

</html>