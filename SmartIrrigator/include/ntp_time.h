#ifndef NTP_TIME_H
#define NTP_TIME_H

#include <Arduino.h>
#include <RTClib.h>

/*
–î–µ–π—Å—Ç–≤—É—é—â–∏–µ –ª–∏—Ü–∞
–°–∏—Å—Ç–µ–º–Ω–æ–µ –≤—Ä–µ–º—è     - –í—Ä–µ–º—è –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã. –ü—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ –æ—Ç–∫—É–¥–∞ —Ç–æ –¥–æ–ª–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è.
NTP                 - –ü—Ä–∏—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
RTC                 - DS3231 –µ—Å–ª–∏ –µ—Å—Ç—å, —Ç–æ –µ—Å—Ç—å. –ú–æ–≥–ª–∞ —Å–µ—Å—Ç—å –±–∞—Ç–∞—Ä–µ–π–∫–∞, —Ç–æ–≥–¥–∞ –Ω–µ—Ç. –ò–ª–∏ –µ–≥–æ –≤–æ–æ–±—â–µ –Ω–µ –ø—Ä–∏–ø–∞—è–ª–∏.

–°–∏—Ç—É–∞—Ü–∏—è	                –ò—Å—Ç–æ—á–Ω–∏–∫ –≤—Ä–µ–º–µ–Ω–∏                                    –î–µ–π—Å—Ç–≤–∏—è
–í–∫–ª—é—á–∏–ª–∏, –ø–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ—Ç   DS3231 ‚Üí –°–∏—Å—Ç–µ–º–Ω–æ–µ –≤—Ä–µ–º—è                            –ü—Ä–æ—á–∏—Ç–∞—Ç—å –∏ –µ—Å–ª–∏ —É–¥–∞–ª–æ—Å—å, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∏—Ç–µ–º–Ω–æ–µ –≤—Ä–µ–º—è.
–ï—Å—Ç—å WiFi –∏ NTP             NTP ‚Üí DS3231 ‚Üí –°–∏—Å—Ç–µ–º–Ω–æ–µ –≤—Ä–µ–º—è                      –û–±–Ω–æ–≤–ª—è—Ç—å RTC –∏–∑ NTP
–ù–µ—Ç WiFi, –Ω–æ RTC —Ä–∞–±–æ—Ç–∞–µ—Ç	DS3231 ‚Üí –°–∏—Å—Ç–µ–º–Ω–æ–µ –≤—Ä–µ–º—è                            –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å RTC, —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –≤—Ä–µ–º—è –≤ NVS
–ù–µ—Ç WiFi –∏ RTC              –°–∏—Å—Ç–µ–º–Ω–æ–µ –≤—Ä–µ–º—è (—Å –¥—Ä–µ–π—Ñ–æ–º)                         –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–µ –≤—Ä–µ–º—è


üìå Status Register (0x0F) DS3231
–ë–∏—Ç	–ù–∞–∑–≤–∞–Ω–∏–µ	–û–ø–∏—Å–∞–Ω–∏–µ
7	OSF         Oscillator Stop Flag ‚Äî —Ñ–ª–∞–≥ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ (1 = —á–∞—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å)
6	EN32kHz     –í–∫–ª—é—á–µ–Ω–∏–µ –≤—ã–≤–æ–¥–∞ 32kHz (1 = –≤–∫–ª—é—á—ë–Ω)
5	BSY         –§–ª–∞–≥ –∑–∞–Ω—è—Ç–æ—Å—Ç–∏ (1 = –∏–¥—ë—Ç –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã)
4	A2F         –§–ª–∞–≥ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è –±—É–¥–∏–ª—å–Ω–∏–∫–∞ 2 (1 = –±—É–¥–∏–ª—å–Ω–∏–∫ —Å—Ä–∞–±–æ—Ç–∞–ª)
3	A1F         –§–ª–∞–≥ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è –±—É–¥–∏–ª—å–Ω–∏–∫–∞ 1 (1 = –±—É–¥–∏–ª—å–Ω–∏–∫ —Å—Ä–∞–±–æ—Ç–∞–ª)
2-0	-           –ù–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è (–æ–±—ã—á–Ω–æ 0)
*/

void initTime(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è NTP –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞

uint16_t getMinutesSinceMidnight(tm &timeInfo); // –í—Ä–µ–º—è –≤ –º–∏–Ω—É—Ç–∞—Ö —Å –ø–æ–ª—É–Ω–æ—á–∏

/// @bri –ü—Ä–∏–∑–Ω–∞–∫ –Ω–∞–ª–∏—á–∏—è –≤—Ä–µ–º–µ–Ω–∏ —Å NTP
/// @return 
bool sntpReady();

/// @brief  –§–ª–∞–≥ –Ω–∞–ª–∏—á–∏—è RTC
/// @return true –µ—Å–ª–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±—ã–ª–∞ —É—Å–ø–µ—à–Ω–∞
bool rtcHasRTC();

/// @brief –§–ª–∞–≥ —Å–±–æ—è RTC –ø–æ –ø–∏—Ç–∞–Ω–∏—é, –ø—Ä–æ—â–µ –≥–æ–≤–æ—Ä—è –≤—Ä–µ–º–µ–Ω–∏ –Ω–µ—Ç!
/// @return 
bool rtcLostPower();

/// @brief –ü—Ä–∏–∑–Ω–∞–∫ –Ω–∞–ª–∏—á–∏—è –≤—Ä–µ–º–µ–Ω–∏ RTC!
/// @return 
bool rtcHasTime();

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ RTC –∏–∑ NTP. –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—Å—ë —É–¥–∞—á–Ω–æ –µ—Å—Ç—å
bool rtcAdjustFromSntp();

bool getRTCTime(struct tm &timeinfo);

float rtcGetTemperature();

// –Ø–≤–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ RTC
bool rtcAdjust(DateTime &dt);

void  syncTimeFromNTP();

void syncSystemTimeFromRTC();

#endif
